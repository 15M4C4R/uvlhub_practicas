name: Flask CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up MariaDB
      uses: getong/mariadb-action@v1.1
      with:
        host port: 3600
        container port: 3600
        character set server: 'utf8'
        collation server: 'utf8_general_ci'
        mariadb version: 'latest'
        mysql database: 'uvlhubdb_test'
        mysql root password: 'uvlhub_root_password'
        mysql user: 'uvlhub_user'
        mysql password: 'uvlhub_password'

    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: bash ./scripts/check_env_and_install.sh

    - name: Run Tests
      env:
        FLASK_ENV: testing
        MARIADB_HOSTNAME: 127.0.0.1
        MARIADB_PORT: 3306
        MARIADB_DATABASE: uvlhubdb_test
        MARIADB_USER: uvlhub_user
        MARIADB_PASSWORD: uvlhub_password
      run: |
        rosemary test
