{% extends "base_template.html" %}

{% block title %}Upload dataset{% endblock %}

{% block content %}

    <h1 class="h3 mb-3">Upload dataset</h1>

    <div class="row">
        <div class="col-lg-6 col-12">
            <div class="card" id="basic_info_form">

                <div class="card-header">
                    <h5 class="card-title">Basic info</h5>
                </div>

                <div class="card-body">

                    {{ form.hidden_tag() }}

                    <div class="row">

                        <div class="col-12">

                            <div class="row">

                                <div class="col-12">
                                    <div class="mb-3">
                                        {{ form.title.label(class="form-label") }}
                                        {{ form.title(class="form-control") }}
                                        {% for error in form.title.errors %}
                                            <span style="color: red;">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="col-12">
                                    <div class="mb-3">
                                        {{ form.description.label(class="form-label") }}
                                        {{ form.description(rows=4, class="form-control") }}
                                        {% for error in form.description.errors %}
                                            <span style="color: red;">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="col-lg-6 col-12">
                                    <div class="mb-3">
                                        {{ form.publication_type.label(class="form-label") }}
                                        {{ form.publication_type(class="form-control") }}
                                    </div>

                                </div>

                                <div class="col-12">
                                    <div class="mb-3">
                                        {{ form.tags.label(class="form-label") }}
                                        {{ form.tags(class="form-control") }}
                                        {% for error in form.tags.errors %}
                                            <span style="color: red;">{{ error }}</span>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="col-12">

                                    <div class="mb-3">

                                        <div id="authors">

                                            {% for author in form.authors.entries %}
                                                <div class="author row">
                                                    {{ author.name.label }} {{ author.name() }}
                                                    {{ author.affiliation.label }} {{ author.affiliation() }}
                                                    {{ author.orcid.label }} {{ author.orcid() }}
                                                    {{ author.gnd.label }} {{ author.gnd() }}
                                                </div>
                                            {% endfor %}


                                        </div>
                                        <button type="button" class="btn btn-secondary" id="add_author">Add author
                                        </button>


                                    </div>

                                </div>


                            </div>

                        </div>

                    </div>

                    <div class="row">

                        {% if error %}

                            <div class="mt-3 col-lg-6 col-12">
                                <span style="color: red;">{{ error }}</span>
                            </div>

                        {% endif %}

                    </div>


                </div>
            </div>
        </div>

        <div class="col-lg-6 col-12">
            <div class="card" id="uploaded_models_form">

                <div class="card-header">
                    <h5 class="card-title">Drag and drop your feature models</h5>
                </div>

                <div class="card-body">

                    <form action="{{ url_for('dataset.upload') }}" class="dropzone" id="myDropzone">
                        <div id="dropzone-text"></div>
                    </form>

                    <ul class="mt-2" id="file-list"></ul>

                    <script>
                        Dropzone.options.myDropzone = {
                            paramName: 'file',
                            maxFilesize: 10,
                            acceptedFiles: '.uvl',
                            init: function () {
                                var fileList = document.getElementById('file-list');
                                var dropzoneText = document.getElementById('dropzone-text');

                                this.on('addedfile', function (file) {

                                    // actions when UVL model is uploaded
                                    let listItem = document.createElement('li');
                                    let h4Element = document.createElement('h4');
                                    h4Element.textContent = file.name;
                                    listItem.appendChild(h4Element);


                                    // generate unique identifier for UVL form
                                    let formUniqueId = generateUniqueId();

                                    /*
                                        ##########################################
                                        FORM BUTTON
                                        ##########################################
                                    */
                                    let formButton = document.createElement('button');
                                    formButton.innerHTML = 'Add info';
                                    formButton.classList.add('info-button', 'btn', 'btn-outline-primary', "btn-sm");
                                    formButton.id = formUniqueId + "_button";

                                    formButton.addEventListener('click', function () {
                                        if (formContainer.style.display === "none") {
                                            formContainer.style.display = "block";
                                        } else {
                                            formContainer.style.display = "none";
                                        }
                                    });

                                    // append space
                                    let space = document.createTextNode(" ");
                                    listItem.appendChild(space);

                                    /*
                                        ##########################################
                                        REMOVE BUTTON
                                        ##########################################
                                    */

                                    // remove button
                                    let removeButton = document.createElement('button');
                                    removeButton.innerHTML = 'Delete';
                                    removeButton.classList.add("remove-button", "btn", "btn-outline-danger", "btn-sm", "remove-button");

                                    // append space
                                    space = document.createTextNode(" ");
                                    listItem.appendChild(space);

                                    removeButton.addEventListener('click', function () {
                                        fileList.removeChild(listItem);
                                        this.removeFile(file);

                                        // Ajax request
                                        var xhr = new XMLHttpRequest();
                                        xhr.open('POST', '/delete', true);
                                        xhr.setRequestHeader('Content-Type', 'application/json');
                                        xhr.onload = function () {
                                            if (xhr.status === 200) {
                                                console.log('Deleted file from server');
                                            }
                                        };
                                        xhr.send(JSON.stringify({file: file.name}));
                                    }.bind(this));

                                    /*
                                        ##########################################
                                        APPEND BUTTONS
                                        ##########################################
                                    */
                                    listItem.appendChild(formButton);
                                    listItem.appendChild(removeButton);

                                    /*
                                        ##########################################
                                        UVL FORM
                                        ##########################################
                                    */

                                    // create specific form for UVL
                                    let formContainer = document.createElement('div');
                                    formContainer.id = formUniqueId + "_form";
                                    formContainer.classList.add('uvl_form', "mt-3");
                                    formContainer.style.display = "none";

                                    formContainer.innerHTML = `
                                                <div class="row">
                                                    <div class="col-12">
                                                        <div class="row">
                                                            <div class="col-12">
                                                                <div class="mb-3">
                                                                    <label class="form-label">Title</label>
                                                                    <input type="text" class="form-control" name="title">
                                                                </div>
                                                            </div>
                                                            <div class="col-12">
                                                                <div class="mb-3">
                                                                    <label class="form-label">Description</label>
                                                                    <textarea rows="4" class="form-control" name="description"></textarea>
                                                                </div>
                                                            </div>
                                                            <div class="col-lg-6 col-12">
                                                                <div class="mb-3">
                                                                    <label class="form-label" for="publication_type">Publication type</label>
                                                                    <select class="form-control" name="uvl_publication_type" required="">
                                                                        <option value="annotationcollection">Annotation Collection</option>
                                                                        <option value="book">Book</option>
                                                                        <option value="section">Book Section</option>
                                                                        <option value="conferencepaper">Conference Paper</option>
                                                                        <option value="datamanagementplan">Data Management Plan</option>
                                                                        <option value="article">Journal Article</option>
                                                                        <option value="patent">Patent</option>
                                                                        <option value="preprint">Preprint</option>
                                                                        <option value="deliverable">Project Deliverable</option>
                                                                        <option value="milestone">Project Milestone</option>
                                                                        <option value="proposal">Proposal</option>
                                                                        <option value="report">Report</option>
                                                                        <option value="softwaredocumentation">Software Documentation</option>
                                                                        <option value="taxonomictreatment">Taxonomic Treatment</option>
                                                                        <option value="technicalnote">Technical Note</option>
                                                                        <option value="thesis">Thesis</option>
                                                                        <option value="workingpaper">Working Paper</option>
                                                                        <option value="other">Other</option>
                                                                    </select>
                                                                </div>
                                                            </div>
                                                            <div class="col-12">
                                                                <div class="mb-3">
                                                                    <label class="form-label">Tags (separated by commas)</label>
                                                                    <input type="text" class="form-control" name="tags">
                                                                </div>
                                                            </div>
                                                            <div class="col-12">
                                                                <div class="mb-3">
                                                                    <label class="form-label">Authors</label>
                                                                    <div id="` + formContainer.id + `_authors">
                                                                    </div>
                                                                    <button type="button" class="add_author_to_uvl btn btn-secondary" id="` + formContainer.id + `_authors_button">Add author</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;

                                    listItem.appendChild(formContainer);
                                    fileList.appendChild(listItem);

                                });

                            }
                        };


                        function generateUniqueId() {
                            return Math.random().toString(36).substr(2, 9);
                        }


                    </script>

                </div>

            </div>
        </div>

    </div>

    <div class="row">

        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Upload dataset</h5>
                </div>
                <div class="card-body">

                    <p class="card-text">
                        <label class="form-check">
                            <input id="agreeCheckbox" class="form-check-input" type="checkbox" value="">
                            <span class="form-check-label">
                                I agree to have my feature models automatically uploaded to Zenodo and made available to the public according to the <a
                                    href="https://en.wikipedia.org/wiki/Open_science" target="_blank">Open Science</a> manifesto
                            </span>
                        </label>
                    </p>

                    <button id="uploadButton" class="btn btn-primary" disabled>Upload dataset</button>

                    <script>
                        const checkbox = document.getElementById('agreeCheckbox');
                        const uploadButton = document.getElementById('uploadButton');

                        checkbox.addEventListener('change', function () {
                            uploadButton.disabled = !checkbox.checked;
                        });
                    </script>

                </div>
            </div>

        </div>

    </div>


    {% block scripts %}

        <script>

            function addField(newAuthor, name, text, className = 'col-lg-6 col-12 mb-3') {
                var fieldWrapper = document.createElement('div');
                fieldWrapper.className = className;

                var label = document.createElement('label');
                label.className = 'form-label';
                label.for = name;
                label.textContent = text;

                var field = document.createElement('input');
                field.name = name;
                field.className = 'form-control';

                fieldWrapper.appendChild(label);
                fieldWrapper.appendChild(field);
                newAuthor.appendChild(fieldWrapper);
            }

            function addRemoveButton(newAuthor) {
                var buttonWrapper = document.createElement('div');
                buttonWrapper.className = 'col-12 mb-2';

                var button = document.createElement('button');
                button.textContent = 'Remove author';
                button.className = 'btn btn-danger';
                button.type = 'button';
                button.addEventListener('click', function (event) {
                    event.preventDefault();
                    newAuthor.remove();
                });

                buttonWrapper.appendChild(button);
                newAuthor.appendChild(buttonWrapper);
            }

            function createAuthorBlock() {
                var newAuthor = document.createElement('div');
                newAuthor.className = 'author row';
                newAuthor.style.cssText = "border:2px dotted #ccc;border-radius:10px;padding:10px;margin:10px 0";

                addField(newAuthor, 'author_name', 'Name');
                addField(newAuthor, 'author_affiliation', 'Affiliation');
                addField(newAuthor, 'author_orcid', 'ORCID');
                addField(newAuthor, 'author_gnd', 'GND');
                addRemoveButton(newAuthor);

                return newAuthor;
            }

            document.getElementById('add_author').addEventListener('click', function () {
                var authors = document.getElementById('authors');
                var newAuthor = createAuthorBlock();
                authors.appendChild(newAuthor);
            });


            document.addEventListener('click', function (event) {
                if (event.target && event.target.classList.contains('add_author_to_uvl')) {

                    let authorsButtonId = event.target.id;
                    let authorsId = authorsButtonId.replace("_button", "");
                    let authors = document.getElementById(authorsId);
                    let newAuthor = createAuthorBlock();
                    authors.appendChild(newAuthor);

                }
            });

            window.onload = function () {
                document.getElementById('uploadButton').addEventListener('click', function () {
                    const formData = {basic_info_form: {}, uploaded_models_form: {}};

                    ["basic_info_form", "uploaded_models_form"].forEach((formId) => {
                        const form = document.getElementById(formId);
                        const inputs = form.querySelectorAll('input, select, textarea');
                        inputs.forEach(input => {
                            if (input.name) {
                                formData[formId][input.name] = formData[formId][input.name] || [];
                                formData[formId][input.name].push(input.value);
                            }
                        });
                    });

                    console.log(JSON.stringify(formData));
                });
            };


        </script>


    {% endblock %}

{% endblock %}